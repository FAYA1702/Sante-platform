%%{init: {'theme':'dark','themeVariables':{ 'primaryColor':'#4F46E5', 'edgeLabelBackground':'#FFFFFF'}}}%%
sequenceDiagram
  participant U as "ğŸ‘¤ Utilisateur"
  participant F as "ğŸŒ Frontend React"
  participant A as "ğŸ” Auth Service"
  participant B as "âš¡ Backend API"
  participant IA as "ğŸ¤– Service IA"
  participant R as "ğŸ“¡ Redis"
  participant DB as "ğŸ—„ï¸ MongoDB"
  participant D as "ğŸ“± Device IoT"

  %% === FLUX D'AUTHENTIFICATION ===
  Note over U,DB: ğŸ” Phase d'Authentification
  U->>F: 1. Connexion (email, password)
  F->>A: 2. POST /auth/token
  A->>DB: 3. VÃ©rifier utilisateur
  DB-->>A: 4. DonnÃ©es utilisateur
  A->>A: 5. Valider mot de passe (bcrypt)
  A->>A: 6. GÃ©nÃ©rer JWT token
  A-->>F: 7. Token JWT + rÃ´le
  F->>F: 8. Stocker token (localStorage)
  F-->>U: 9. Redirection dashboard

  %% === FLUX COLLECTE DE DONNÃ‰ES ===
  Note over U,DB: ğŸ“Š Phase de Collecte de DonnÃ©es
  
  %% Saisie manuelle
  U->>F: 10. Saisir donnÃ©es santÃ©
  F->>B: 11. POST /data (+ JWT header)
  B->>B: 12. Valider JWT & permissions
  B->>DB: 13. InsÃ©rer Donnee
  DB-->>B: 14. Confirmation insertion
  
  %% Ou collecte automatique
  par Collecte Device IoT
    D->>B: 10b. Transmettre donnÃ©es capteurs
    B->>B: 11b. Valider donnÃ©es device
    B->>DB: 12b. InsÃ©rer Donnee (device_id)
  end

  %% === FLUX ANALYSE IA ===
  Note over B,R: ğŸ¤– Phase d'Analyse IA Temps RÃ©el
  B->>IA: 15. DÃ©clencher analyse (nouvelle donnÃ©e)
  IA->>DB: 16. RÃ©cupÃ©rer historique patient
  DB-->>IA: 17. DonnÃ©es historiques
  IA->>IA: 18. Analyser anomalies (algorithmes ML)
  
  alt Anomalie dÃ©tectÃ©e (critique)
    IA->>DB: 19a. CrÃ©er Alerte (niveau CRITICAL)
    IA->>R: 20a. PUBLISH alerte_channel
    Note right of R: ğŸ“¡ Streaming temps rÃ©el
    R-->>F: 21a. SSE: nouvelle alerte
    F-->>U: 22a. ğŸš¨ Notification alerte critique
  else Recommandation gÃ©nÃ©rÃ©e
    IA->>DB: 19b. CrÃ©er Recommandation
    IA->>R: 20b. PUBLISH reco_channel
    R-->>F: 21b. SSE: nouvelle recommandation
    F-->>U: 22b. ğŸ’¡ Affichage recommandation
  end

  %% === FLUX CONSULTATION MÃ‰DECIN ===
  Note over U,DB: ğŸ‘¨â€âš•ï¸ Phase Consultation MÃ©dicale
  U->>F: 23. MÃ©decin consulte dashboard
  F->>B: 24. GET /alerts/stream (SSE)
  B->>R: 25. SUBSCRIBE alertes_temps_reel
  
  loop Streaming continu
    R-->>B: 26. Nouvelle alerte patient
    B-->>F: 27. SSE: alerte + user_id
    F->>F: 28. Mise Ã  jour UI temps rÃ©el
    F-->>U: 29. ğŸ”” Badge notification
  end
  
  U->>F: 30. Clic sur alerte â†’ fiche patient
  F->>B: 31. GET /patients/{user_id}/summary
  B->>DB: 32. RÃ©cupÃ©rer donnÃ©es patient
  DB-->>B: 33. Historique + recommandations
  B-->>F: 34. DonnÃ©es patient complÃ¨tes
  F-->>U: 35. ğŸ“‹ Affichage fiche dÃ©taillÃ©e

  %% === FLUX RBAC ET SÃ‰CURITÃ‰ ===
  Note over A,DB: ğŸ›¡ï¸ ContrÃ´les de SÃ©curitÃ© Continus
  
  rect rgb(255, 200, 200)
    Note over B: Chaque requÃªte API vÃ©rifie:
    Note over B: âœ“ JWT valide
    Note over B: âœ“ RÃ´le autorisÃ© (RBAC)
    Note over B: âœ“ AccÃ¨s aux donnÃ©es patient
    Note over B: âœ“ ConformitÃ© RGPD
  end
